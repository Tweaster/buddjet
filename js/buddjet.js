
// As of version 0
var new_user_raw_data = '{"formatVersion":0,"lastCommit":[{"year":2016,"month":1,"date":1,"hours":0,"minutes":0,"seconds":0}],"currentMonthIndex":1,"categories":[{"category":"income","caption":"Income","monthlyProjection":[0,0,0,0,0,0,0,0,0,0,0,0],"yearlyProjection":[0,0,0,0,0,0,0,0,0,0,0,0],"expenses":[{"id":"-ef8c-4ab9-b436","caption":"Income #1","frequency":"weekly","value":0,"monthlyProjection":[0,0,0,0,0,0,0,0,0,0,0,0],"yearlyProjection":[0,0,0,0,0,0,0,0,0,0,0,0],"monthlyTotals":[0,0,0,0,0,0,0,0,0,0,0,0]},{"id":"-fab1-1ce2-a9c0","caption":"Income #2","frequency":"monthly","value":0,"monthlyProjection":[0,0,0,0,0,0,0,0,0,0,0,0],"yearlyProjection":[0,0,0,0,0,0,0,0,0,0,0,0],"monthlyTotals":[0,0,0,0,0,0,0,0,0,0,0,0]},{"id":"-a6d1-4fab-11ce","caption":"Additional Income","frequency":"monthly","value":0,"monthlyProjection":[0,0,0,0,0,0,0,0,0,0,0,0],"yearlyProjection":[0,0,0,0,0,0,0,0,0,0,0,0],"monthlyTotals":[0,0,0,0,0,0,0,0,0,0,0,0]}]},{"category":"housing","caption":"Housing","monthlyProjection":[0,0,0,0,0,0,0,0,0,0,0,0],"yearlyProjection":[0,0,0,0,0,0,0,0,0,0,0,0],"expenses":[{"id":"-bf8c-4ab9-bb34","caption":"Mortgage/Rent","frequency":"weekly","value":0,"monthlyProjection":[0,0,0,0,0,0,0,0,0,0,0,0],"yearlyProjection":[0,0,0,0,0,0,0,0,0,0,0,0],"monthlyTotals":[0,0,0,0,0,0,0,0,0,0,0,0]},{"id":"-e23c-4d92-a9c0","caption":"Maintenance","frequency":"monthly","value":"0.0","monthlyProjection":[0,0,0,0,0,0,0,0,0,0,0,0],"yearlyProjection":[0,0,0,0,0,0,0,0,0,0,0,0],"monthlyTotals":[0,0,0,0,0,0,0,0,0,0,0,0]},{"id":"-a6d1-4942-8904","caption":"HOA Dues","frequency":"monthly","value":0,"monthlyProjection":[0,0,0,0,0,0,0,0,0,0,0,0],"yearlyProjection":[0,0,0,0,0,0,0,0,0,0,0,0],"monthlyTotals":[0,0,0,0,0,0,0,0,0,0,0,0]}]},{"category":"transportation","caption":"Transportation","monthlyProjection":[0,0,0,0,0,0,0,0,0,0,0,0],"yearlyProjection":[0,0,0,0,0,0,0,0,0,0,0,0],"expenses":[{"id":"-57be-4c95-b2e6","caption":"Car loan #1","frequency":"monthly","value":0,"monthlyProjection":[0,0,0,0,0,0,0,0,0,0,0,0],"yearlyProjection":[0,0,0,0,0,0,0,0,0,0,0,0],"monthlyTotals":[0,0,0,0,0,0,0,0,0,0,0,0]},{"id":"-f292-48d6-b5ff","caption":"Public Transportation","frequency":"monthly","value":0,"monthlyProjection":[0,0,0,0,0,0,0,0,0,0,0,0],"yearlyProjection":[0,0,0,0,0,0,0,0,0,0,0,0],"monthlyTotals":[0,0,0,0,0,0,0,0,0,0,0,0]},{"id":"-9b56-4e4a-aa89","caption":"Gas","frequency":"monthly","value":0,"monthlyProjection":[0,0,0,0,0,0,0,0,0,0,0,0],"yearlyProjection":[0,0,0,0,0,0,0,0,0,0,0,0],"monthlyTotals":[0,0,0,0,0,0,0,0,0,0,0,0]},{"id":"-6be8-43b1-8cd5","caption":"DMV Fees","frequency":"monthly","value":"0.0","monthlyProjection":[0,0,0,0,0,0,0,0,0,0,0,0],"yearlyProjection":[0,0,0,0,0,0,0,0,0,0,0,0],"monthlyTotals":[0,0,0,0,0,0,0,0,0,0,0,0]},{"id":"-ab5a-47c5-a7d4","caption":"Parking Fees","frequency":"monthly","value":0,"monthlyProjection":[0,0,0,0,0,0,0,0,0,0,0,0],"yearlyProjection":[0,0,0,0,0,0,0,0,0,0,0,0],"monthlyTotals":[0,0,0,0,0,0,0,0,0,0,0,0]},{"id":"-babd-4a65-8540","caption":"Oil Changes","frequency":"monthly","value":0,"monthlyProjection":[0,0,0,0,0,0,0,0,0,0,0,0],"yearlyProjection":[0,0,0,0,0,0,0,0,0,0,0,0],"monthlyTotals":[0,0,0,0,0,0,0,0,0,0,0,0]},{"id":"-7968-4574-9d0f","caption":"Repairs","frequency":"monthly","value":0,"monthlyProjection":[0,0,0,0,0,0,0,0,0,0,0,0],"yearlyProjection":[0,0,0,0,0,0,0,0,0,0,0,0],"monthlyTotals":[0,0,0,0,0,0,0,0,0,0,0,0]},{"id":"-0915-4bde-b53b","caption":"Maintenance","frequency":"monthly","value":0,"monthlyProjection":[0,0,0,0,0,0,0,0,0,0,0,0],"yearlyProjection":[0,0,0,0,0,0,0,0,0,0,0,0],"monthlyTotals":[0,0,0,0,0,0,0,0,0,0,0,0]}]},{"category":"medical","caption":"Medical","monthlyProjection":[0,0,0,0,0,0,0,0,0,0,0,0],"yearlyProjection":[0,0,0,0,0,0,0,0,0,0,0,0],"expenses":[{"id":"-c93f-4fce-a337","caption":"Office Visits","frequency":"monthly","value":0,"monthlyProjection":[0,0,0,0,0,0,0,0,0,0,0,0],"yearlyProjection":[0,0,0,0,0,0,0,0,0,0,0,0],"monthlyTotals":[0,0,0,0,0,0,0,0,0,0,0,0]},{"id":"-6428-4d17-968f","caption":"Dental ","frequency":"monthly","value":0,"monthlyProjection":[0,0,0,0,0,0,0,0,0,0,0,0],"yearlyProjection":[0,0,0,0,0,0,0,0,0,0,0,0],"monthlyTotals":[0,0,0,0,0,0,0,0,0,0,0,0]},{"id":"-8238-47ec-bf7b","caption":"Glasses/Contacts","frequency":"monthly","value":0,"monthlyProjection":[0,0,0,0,0,0,0,0,0,0,0,0],"yearlyProjection":[0,0,0,0,0,0,0,0,0,0,0,0],"monthlyTotals":[0,0,0,0,0,0,0,0,0,0,0,0]},{"id":"-95c5-48f9-b845","caption":"Specialty Care","frequency":"monthly","value":0,"monthlyProjection":[0,0,0,0,0,0,0,0,0,0,0,0],"yearlyProjection":[0,0,0,0,0,0,0,0,0,0,0,0],"monthlyTotals":[0,0,0,0,0,0,0,0,0,0,0,0]},{"id":"-041b-4753-9410","caption":"Medications","frequency":"monthly","value":0,"monthlyProjection":[0,0,0,0,0,0,0,0,0,0,0,0],"yearlyProjection":[0,0,0,0,0,0,0,0,0,0,0,0],"monthlyTotals":[0,0,0,0,0,0,0,0,0,0,0,0]}]},{"category":"utilities","caption":"Utilities","monthlyProjection":[0,0,0,0,0,0,0,0,0,0,0,0],"yearlyProjection":[0,0,0,0,0,0,0,0,0,0,0,0],"expenses":[{"id":"-563e-419f-a6ec","caption":"Natural Gas","frequency":"monthly","value":0,"monthlyProjection":[0,0,0,0,0,0,0,0,0,0,0,0],"yearlyProjection":[0,0,0,0,0,0,0,0,0,0,0,0],"monthlyTotals":[0,0,0,0,0,0,0,0,0,0,0,0]},{"id":"-55a1-4266-802d","caption":"Electric","frequency":"monthly","value":0,"monthlyProjection":[0,0,0,0,0,0,0,0,0,0,0,0],"yearlyProjection":[0,0,0,0,0,0,0,0,0,0,0,0],"monthlyTotals":[0,0,0,0,0,0,0,0,0,0,0,0]},{"id":"-864f-4744-903e","caption":"Water","frequency":"monthly","value":0,"monthlyProjection":[0,0,0,0,0,0,0,0,0,0,0,0],"yearlyProjection":[0,0,0,0,0,0,0,0,0,0,0,0],"monthlyTotals":[0,0,0,0,0,0,0,0,0,0,0,0]},{"id":"-b56e-4499-836a","caption":"Sewer","frequency":"monthly","value":0,"monthlyProjection":[0,0,0,0,0,0,0,0,0,0,0,0],"yearlyProjection":[0,0,0,0,0,0,0,0,0,0,0,0],"monthlyTotals":[0,0,0,0,0,0,0,0,0,0,0,0]},{"id":"-4cfc-43e6-b8dc","caption":"Trash/Recycling","frequency":"monthly","value":0,"monthlyProjection":[0,0,0,0,0,0,0,0,0,0,0,0],"yearlyProjection":[0,0,0,0,0,0,0,0,0,0,0,0],"monthlyTotals":[0,0,0,0,0,0,0,0,0,0,0,0]},{"id":"-e051-4d3b-ab71","caption":"Phone (home)","frequency":"monthly","value":0,"monthlyProjection":[0,0,0,0,0,0,0,0,0,0,0,0],"yearlyProjection":[0,0,0,0,0,0,0,0,0,0,0,0],"monthlyTotals":[0,0,0,0,0,0,0,0,0,0,0,0]},{"id":"-d4e5-499f-8612","caption":"Phone (cell)","frequency":"monthly","value":0,"monthlyProjection":[0,0,0,0,0,0,0,0,0,0,0,0],"yearlyProjection":[0,0,0,0,0,0,0,0,0,0,0,0],"monthlyTotals":[0,0,0,0,0,0,0,0,0,0,0,0]},{"id":"-9fec-4784-a176","caption":"Internet","frequency":"monthly","value":0,"monthlyProjection":[0,0,0,0,0,0,0,0,0,0,0,0],"yearlyProjection":[0,0,0,0,0,0,0,0,0,0,0,0],"monthlyTotals":[0,0,0,0,0,0,0,0,0,0,0,0]},{"id":"-4b4b-42cc-b99b","caption":"Cable","frequency":"monthly","value":0,"monthlyProjection":[0,0,0,0,0,0,0,0,0,0,0,0],"yearlyProjection":[0,0,0,0,0,0,0,0,0,0,0,0],"monthlyTotals":[0,0,0,0,0,0,0,0,0,0,0,0]}]},{"category":"personal","caption":"Personal","monthlyProjection":[0,0,0,0,0,0,0,0,0,0,0,0],"yearlyProjection":[0,0,0,0,0,0,0,0,0,0,0,0],"expenses":[{"id":"-6c9f-4bde-bdc2","caption":"Clothing","frequency":"monthly","value":0,"monthlyProjection":[0,0,0,0,0,0,0,0,0,0,0,0],"yearlyProjection":[0,0,0,0,0,0,0,0,0,0,0,0],"monthlyTotals":[0,0,0,0,0,0,0,0,0,0,0,0]},{"id":"-bb86-4f25-a71e","caption":"Gym Membership","frequency":"monthly","value":0,"monthlyProjection":[0,0,0,0,0,0,0,0,0,0,0,0],"yearlyProjection":[0,0,0,0,0,0,0,0,0,0,0,0],"monthlyTotals":[0,0,0,0,0,0,0,0,0,0,0,0]},{"id":"-6012-473a-9d6e","caption":"Hair Cuts","frequency":"monthly","value":0,"monthlyProjection":[0,0,0,0,0,0,0,0,0,0,0,0],"yearlyProjection":[0,0,0,0,0,0,0,0,0,0,0,0],"monthlyTotals":[0,0,0,0,0,0,0,0,0,0,0,0]},{"id":"-16c2-4dcb-be19","caption":"Baby Sitters","frequency":"monthly","value":0,"monthlyProjection":[0,0,0,0,0,0,0,0,0,0,0,0],"yearlyProjection":[0,0,0,0,0,0,0,0,0,0,0,0],"monthlyTotals":[0,0,0,0,0,0,0,0,0,0,0,0]},{"id":"-9bc3-404c-b222","caption":"Child Support","frequency":"monthly","value":0,"monthlyProjection":[0,0,0,0,0,0,0,0,0,0,0,0],"yearlyProjection":[0,0,0,0,0,0,0,0,0,0,0,0],"monthlyTotals":[0,0,0,0,0,0,0,0,0,0,0,0]},{"id":"-908c-403b-89a2","caption":"Alimony","frequency":"monthly","value":0,"monthlyProjection":[0,0,0,0,0,0,0,0,0,0,0,0],"yearlyProjection":[0,0,0,0,0,0,0,0,0,0,0,0],"monthlyTotals":[0,0,0,0,0,0,0,0,0,0,0,0]}]},{"category":"entertainment","caption":"Entertainment","monthlyProjection":[0,0,0,0,0,0,0,0,0,0,0,0],"yearlyProjection":[0,0,0,0,0,0,0,0,0,0,0,0],"expenses":[{"id":"-bd19-4ddc-b3f5","caption":"Subscriptions","frequency":"monthly","value":0,"monthlyProjection":[0,0,0,0,0,0,0,0,0,0,0,0],"yearlyProjection":[0,0,0,0,0,0,0,0,0,0,0,0],"monthlyTotals":[0,0,0,0,0,0,0,0,0,0,0,0]},{"id":"-c494-4e9f-99f4","caption":"Eating Out","frequency":"weekly","value":0,"monthlyProjection":[0,0,0,0,0,0,0,0,0,0,0,0],"yearlyProjection":[0,0,0,0,0,0,0,0,0,0,0,0],"monthlyTotals":[0,0,0,0,0,0,0,0,0,0,0,0]},{"id":"-c164-4110-8bfb","caption":"Vacation Fund","frequency":"monthly","value":0,"monthlyProjection":[0,0,0,0,0,0,0,0,0,0,0,0],"yearlyProjection":[0,0,0,0,0,0,0,0,0,0,0,0],"monthlyTotals":[0,0,0,0,0,0,0,0,0,0,0,0]}]},{"category":"household","caption":"Household Items","monthlyProjection":[0,0,0,0,0,0,0,0,0,0,0,0],"yearlyProjection":[0,0,0,0,0,0,0,0,0,0,0,0],"expenses":[{"id":"-6308-4ad9-ab5c","caption":"Groceries","frequency":"weekly","value":0,"monthlyProjection":[0,0,0,0,0,0,0,0,0,0,0,0],"yearlyProjection":[0,0,0,0,0,0,0,0,0,0,0,0],"monthlyTotals":[0,0,0,0,0,0,0,0,0,0,0,0]},{"id":"-f601-4fe4-af0d","caption":"Toiletries","frequency":"monthly","value":0,"monthlyProjection":[0,0,0,0,0,0,0,0,0,0,0,0],"yearlyProjection":[0,0,0,0,0,0,0,0,0,0,0,0],"monthlyTotals":[0,0,0,0,0,0,0,0,0,0,0,0]}]},{"category":"giving","caption":"Giving","monthlyProjection":[0,0,0,0,0,0,0,0,0,0,0,0],"yearlyProjection":[0,0,0,0,0,0,0,0,0,0,0,0],"expenses":[{"id":"-1192-4221-b501","caption":"Tithing","frequency":"monthly","value":0,"monthlyProjection":[0,0,0,0,0,0,0,0,0,0,0,0],"yearlyProjection":[0,0,0,0,0,0,0,0,0,0,0,0],"monthlyTotals":[0,0,0,0,0,0,0,0,0,0,0,0]},{"id":"-46da-447c-a15d","caption":"Charities","frequency":"monthly","value":0,"monthlyProjection":[0,0,0,0,0,0,0,0,0,0,0,0],"yearlyProjection":[0,0,0,0,0,0,0,0,0,0,0,0],"monthlyTotals":[0,0,0,0,0,0,0,0,0,0,0,0]},{"id":"-453b-46d4-87fe","caption":"Christmas Fund","frequency":"monthly","value":"0.0","monthlyProjection":[0,0,0,0,0,0,0,0,0,0,0,0],"yearlyProjection":[0,0,0,0,0,0,0,0,0,0,0,0],"monthlyTotals":[0,0,0,0,0,0,0,0,0,0,0,0]},{"id":"-a679-46da-8f70","caption":"Birthday Fund","frequency":"monthly","value":0,"monthlyProjection":[0,0,0,0,0,0,0,0,0,0,0,0],"yearlyProjection":[0,0,0,0,0,0,0,0,0,0,0,0],"monthlyTotals":[0,0,0,0,0,0,0,0,0,0,0,0]},{"id":"-dbc9-4407-a88a","caption":"Wedding/Anniversary Fund","frequency":"monthly","value":0,"monthlyProjection":[0,0,0,0,0,0,0,0,0,0,0,0],"yearlyProjection":[0,0,0,0,0,0,0,0,0,0,0,0],"monthlyTotals":[0,0,0,0,0,0,0,0,0,0,0,0]}]},{"category":"pets","caption":"Pets","monthlyProjection":[0,0,0,0,0,0,0,0,0,0,0,0],"yearlyProjection":[0,0,0,0,0,0,0,0,0,0,0,0],"expenses":[{"id":"-c7ec-4c9c-be91","caption":"Vet Visits","frequency":"monthly","value":0,"monthlyProjection":[0,0,0,0,0,0,0,0,0,0,0,0],"yearlyProjection":[0,0,0,0,0,0,0,0,0,0,0,0],"monthlyTotals":[0,0,0,0,0,0,0,0,0,0,0,0]},{"id":"-87a8-46e9-b20d","caption":"Food","frequency":"monthly","value":0,"monthlyProjection":[0,0,0,0,0,0,0,0,0,0,0,0],"yearlyProjection":[0,0,0,0,0,0,0,0,0,0,0,0],"monthlyTotals":[0,0,0,0,0,0,0,0,0,0,0,0]},{"id":"-e33b-4d2c-8b26","caption":"Medicine","frequency":"monthly","value":0,"monthlyProjection":[0,0,0,0,0,0,0,0,0,0,0,0],"yearlyProjection":[0,0,0,0,0,0,0,0,0,0,0,0],"monthlyTotals":[0,0,0,0,0,0,0,0,0,0,0,0]}]},{"category":"insurance","caption":"Insurance","monthlyProjection":[0,0,0,0,0,0,0,0,0,0,0,0],"yearlyProjection":[0,0,0,0,0,0,0,0,0,0,0,0],"expenses":[{"id":"-6cb7-46da-b399","caption":"Homeowners Insurance","frequency":"monthly","value":0,"monthlyProjection":[0,0,0,0,0,0,0,0,0,0,0,0],"yearlyProjection":[0,0,0,0,0,0,0,0,0,0,0,0],"monthlyTotals":[0,0,0,0,0,0,0,0,0,0,0,0]},{"id":"-1865-4509-ae41","caption":"Renters Insurance","frequency":"monthly","value":0,"monthlyProjection":[0,0,0,0,0,0,0,0,0,0,0,0],"yearlyProjection":[0,0,0,0,0,0,0,0,0,0,0,0],"monthlyTotals":[0,0,0,0,0,0,0,0,0,0,0,0]},{"id":"-148e-4fd5-a423","caption":"Health Insurance","frequency":"monthly","value":0,"monthlyProjection":[0,0,0,0,0,0,0,0,0,0,0,0],"yearlyProjection":[0,0,0,0,0,0,0,0,0,0,0,0],"monthlyTotals":[0,0,0,0,0,0,0,0,0,0,0,0]},{"id":"-3013-49f3-b18b","caption":"Auto Insurance","frequency":"monthly","value":0,"monthlyProjection":[0,0,0,0,0,0,0,0,0,0,0,0],"yearlyProjection":[0,0,0,0,0,0,0,0,0,0,0,0],"monthlyTotals":[0,0,0,0,0,0,0,0,0,0,0,0]},{"id":"-03f7-4db2-a35d","caption":"Life Insurance","frequency":"monthly","value":0,"monthlyProjection":[0,0,0,0,0,0,0,0,0,0,0,0],"yearlyProjection":[0,0,0,0,0,0,0,0,0,0,0,0],"monthlyTotals":[0,0,0,0,0,0,0,0,0,0,0,0]},{"id":"-1350-4ac6-aefd","caption":"Disability Insurance","frequency":"monthly","value":0,"monthlyProjection":[0,0,0,0,0,0,0,0,0,0,0,0],"yearlyProjection":[0,0,0,0,0,0,0,0,0,0,0,0],"monthlyTotals":[0,0,0,0,0,0,0,0,0,0,0,0]},{"id":"-f3fb-48bc-b2f8","caption":"LTC Insurance","frequency":"monthly","value":0,"monthlyProjection":[0,0,0,0,0,0,0,0,0,0,0,0],"yearlyProjection":[0,0,0,0,0,0,0,0,0,0,0,0],"monthlyTotals":[0,0,0,0,0,0,0,0,0,0,0,0]}]},{"category":"taxes","caption":"Taxes","monthlyProjection":[0,0,0,0,0,0,0,0,0,0,0,0],"yearlyProjection":[0,0,0,0,0,0,0,0,0,0,0,0],"expenses":[{"id":"-603f-436c-93da","caption":"Real Estate Taxes","frequency":"monthly","value":0,"monthlyProjection":[0,0,0,0,0,0,0,0,0,0,0,0],"yearlyProjection":[0,0,0,0,0,0,0,0,0,0,0,0],"monthlyTotals":[0,0,0,0,0,0,0,0,0,0,0,0]},{"id":"-2f79-4024-bb0e","caption":"Personal Property Taxes","frequency":"monthly","value":0,"monthlyProjection":[0,0,0,0,0,0,0,0,0,0,0,0],"yearlyProjection":[0,0,0,0,0,0,0,0,0,0,0,0],"monthlyTotals":[0,0,0,0,0,0,0,0,0,0,0,0]}]},{"category":"debt","caption":"Debt Reduction","monthlyProjection":[0,0,0,0,0,0,0,0,0,0,0,0],"yearlyProjection":[0,0,0,0,0,0,0,0,0,0,0,0],"expenses":[{"id":"-cdf1-482c-89c8","caption":"Credit Cards","frequency":"monthly","value":0,"monthlyProjection":[0,0,0,0,0,0,0,0,0,0,0,0],"yearlyProjection":[0,0,0,0,0,0,0,0,0,0,0,0],"monthlyTotals":[0,0,0,0,0,0,0,0,0,0,0,0]},{"id":"-08d4-4cb8-b699","caption":"Personal Loans","frequency":"monthly","value":0,"monthlyProjection":[0,0,0,0,0,0,0,0,0,0,0,0],"yearlyProjection":[0,0,0,0,0,0,0,0,0,0,0,0],"monthlyTotals":[0,0,0,0,0,0,0,0,0,0,0,0]},{"id":"-f63f-4cd7-9b4b","caption":"Student Loans","frequency":"monthly","value":0,"monthlyProjection":[0,0,0,0,0,0,0,0,0,0,0,0],"yearlyProjection":[0,0,0,0,0,0,0,0,0,0,0,0],"monthlyTotals":[0,0,0,0,0,0,0,0,0,0,0,0]}]},{"category":"education","caption":"Education","monthlyProjection":[0,0,0,0,0,0,0,0,0,0,0,0],"yearlyProjection":[0,0,0,0,0,0,0,0,0,0,0,0],"expenses":[{"id":"-32d2-4e72-9225","caption":"Tuition","frequency":"monthly","value":0,"monthlyProjection":[0,0,0,0,0,0,0,0,0,0,0,0],"yearlyProjection":[0,0,0,0,0,0,0,0,0,0,0,0],"monthlyTotals":[0,0,0,0,0,0,0,0,0,0,0,0]},{"id":"-a770-4ff9-9f09","caption":"College Fund","frequency":"monthly","value":0,"monthlyProjection":[0,0,0,0,0,0,0,0,0,0,0,0],"yearlyProjection":[0,0,0,0,0,0,0,0,0,0,0,0],"monthlyTotals":[0,0,0,0,0,0,0,0,0,0,0,0]},{"id":"-fb15-45d5-8e70","caption":"School Supplies","frequency":"monthly","value":0,"monthlyProjection":[0,0,0,0,0,0,0,0,0,0,0,0],"yearlyProjection":[0,0,0,0,0,0,0,0,0,0,0,0],"monthlyTotals":[0,0,0,0,0,0,0,0,0,0,0,0]}]},{"category":"savings","caption":"Savings","monthlyProjection":[0,0,0,0,0,0,0,0,0,0,0,0],"yearlyProjection":[0,0,0,0,0,0,0,0,0,0,0,0],"expenses":[{"id":"-84a0-477c-9d75","caption":"Emergency Fund","frequency":"monthly","value":0,"monthlyProjection":[0,0,0,0,0,0,0,0,0,0,0,0],"yearlyProjection":[0,0,0,0,0,0,0,0,0,0,0,0],"monthlyTotals":[0,0,0,0,0,0,0,0,0,0,0,0]},{"id":"-2294-46fb-b9a7","caption":"Misc savings","frequency":"monthly","value":0,"monthlyProjection":[0,0,0,0,0,0,0,0,0,0,0,0],"yearlyProjection":[0,0,0,0,0,0,0,0,0,0,0,0],"monthlyTotals":[0,0,0,0,0,0,0,0,0,0,0,0]}]}]}'


var app_id = "org.projectfurnace.buddjet";
var current_format_version = 0;

// declare global variables here
var expenseDonutChart;
var balanceBarChart;
var tendencyBarChart;

var updateCharts;

var user_data;


var number_of_displayed_months = 6;


function getUTCCurrentMonth()
{
  var d = new Date();
  return d.getUTCMonth();
}

var current_displayed_month = getUTCCurrentMonth();



function percentageAsString(currentValue, maxValue)
{
  var result = Math.floor(currentValue * 100.0 / (maxValue < 1.0 ? 1.0 : maxValue));
  return result.toString() + '%';
}

/*
function getRandomColor() {
    var letters = '0123456789ABCDEF';
    var color = '#';
    for (var i = 0; i < 6; i++ ) {
        color += letters[Math.floor(Math.random() * 16)];
    }
    return color;
}
*/

function getRandomColor() {
    var letters = '0123456789ABCDEF';
    var color = '#FF';
    for (var i = 0; i < 4; i++ ) {
        color += letters[Math.floor(Math.random() * 10)];
    }

    return color;
}


function compareExpense(a, b)
{
  if (a.amount < b.amount)
    return 1;
  if (a.amount > b.amount)
    return -1;
  if (a.budgeted < b.budgeted)
    return 1;
  if (a.budgeted > b.budgeted)
    return -1;
  return 0
}


function updateMonthsCombo()
{
  var d = new Date();
  var currentYear = d.getUTCFullYear();
  var currentMonth = d.getUTCMonth();
  var months = ['January', 'February', 'March', 'April', 'May', 'June', 'July', 'August', 'September', 'October', 'November', 'December'];

  for (var i = 0; i < number_of_displayed_months - 1; i++)
  {
    var index = currentMonth - 2 - i;
    index = index < 0 ? index + 12 : index;
    var caption = months[index] + ' ' + (index > currentMonth ? currentYear - 1 : currentYear).toString();
    $('#ui-board-select').append('<option value="' + (2 + i).toString() + '">' + caption + '</option>');
    
  }
  
}

function tendencyChartData(category)
{
  var chartData = [];

  var d = new Date();
  var currentYear = d.getUTCFullYear();
  var currentMonth = d.getUTCMonth();
  var months = ['January', 'February', 'March', 'April', 'May', 'June', 'July', 'August', 'September', 'October', 'November', 'December'];

  for (var i = 0; i < number_of_displayed_months; i++)
  {
    var index = currentMonth - i;
    index = index < 0 ? index + 12 : index;
    var caption = months[index] + ' ' + (index > currentMonth ? currentYear - 1 : currentYear).toString() + ' ';

    if (category == 'all')
    {
      var budgeted = 0.0;
      var amount = 0.0;
      var income = 0.0;
      for (var j = 0; j < user_data.categories.length; j++)
      {
        if (user_data.categories[j].category != 'income')
        {
          budgeted += user_data.categories[j].monthlyProjection[index];
          for (var k = 0; k < user_data.categories[j].expenses.length; k++)
          {
            amount += user_data.categories[j].expenses[k].monthlyTotals[index]; 
          }
        }
        else
        {
          for (var k = 0; k < user_data.categories[j].expenses.length; k++)
          {
            income += user_data.categories[j].expenses[k].monthlyTotals[index]; 
          }
        }
      }
      var p = percentageAsString(amount, budgeted);
      caption += '(' + p + ')';
      chartData.push({
          "caption": caption,
          "amount": amount,
          "budgeted": Math.floor(budgeted),
          "income" : Math.floor(income),
          "color" : "#ff2655",
          "dashLengthColumn": j != currentMonth ? 5 : 1,
          "alpha": j != currentMonth ? 0.5 : 0.8,
          "additional" : "   (i.e: " + p + " compared to prevision)"
      });
    }
    else
    {
      if (category != 'income')
      {
        var categoryObjects = user_data.categories.filter(function(item){return item.category == category; }); 
        var budgeted = categoryObjects[0].monthlyProjection[index];
        var amount = 0.0;
        for (var j = 0; j < categoryObjects[0].expenses.length; j++)
        {
          amount += categoryObjects[0].expenses[j].monthlyTotals[index]; 
        }
        var p = percentageAsString(amount, budgeted);
        caption += '(' + p + ')';
        chartData.push({
            "caption": caption,
            "amount": Math.floor(amount),
            "budgeted": Math.floor(budgeted),
            "color" : "#ff2655",
            "dashLengthColumn": j != currentMonth ? 5 : 1,
            "alpha": j != currentMonth ? 0.5 : 0.8,
            "additional" : "   (i.e: " + percentageAsString(income, budgeted) + " compared to prevision)"
        });
      }
      else 
      {
        var expense = 0.0;
        var income = 0.0;
        var budgetedExpense = 0.0;
        var budgetedIncome = 0.0;
        for (var j = 0; j < user_data.categories.length; j++)
        {
          for (var k = 0; k < user_data.categories[j].expenses.length; k++)
          { 
            if (user_data.categories[j].category != 'income')
            {
              budgetedExpense += user_data.categories[j].expenses[k].monthlyProjection[index];
              expense += user_data.categories[j].expenses[k].monthlyTotals[index];
            }
            else
            {
              budgetedIncome += user_data.categories[j].expenses[k].monthlyProjection[index];
              income += user_data.categories[j].expenses[k].monthlyTotals[index];
            }
          }
        }
        chartData.push({
            "caption": caption,
            "amount": Math.floor(expense),
            "budgeted": Math.floor(budgetedExpense),
            "income" : Math.floor(income),
            "budgetedIncome" : Math.floor(budgetedIncome),
            "color" : "#ff2655",
            "dashLengthColumn": j != currentMonth ? 5 : 1,
            "alpha": j != currentMonth ? 0.5 : 0.8
        });
      }
    }
  }

  return chartData;

}



function generateExpenseChartData(currentContext, category)
{
  var chartData = [];


  if (currentContext == 'prevision')
  {
    if (category == 'all')
    {
      for (var i = 0; i < user_data.categories.length; i++)
      {
        var amount = Math.floor(user_data.categories[i].monthlyProjection[getUTCCurrentMonth()]);
        var caption = user_data.categories[i].caption;
        if (amount > 0.1 && user_data.categories[i].category != 'income')
        {
          chartData.push({
              "caption": caption,
              "budgeted": amount,
              "color" : "#ff2655"
          });
        }
      }
    }
    else
    {
      if (category != 'income')
      {
        var categoryObjects = user_data.categories.filter(function(item){return item.category == category; });
        for (var i = 0; i < categoryObjects[0].expenses.length; i++)
        {
          var amount = Math.floor(categoryObjects[0].expenses[i].monthlyProjection[getUTCCurrentMonth()]);
            var caption = categoryObjects[0].expenses[i].caption;
            chartData.push({
                "budgeted": amount,
                "color" : "#ff2655"
            });
          
        }
      }
      else
      {
        var expense = 0.0;
        var income = 0.0;
        for (var i = 0; i < user_data.categories.length; i++)
        {
          for (var j = 0; j < user_data.categories[i].expenses.length; j++)
          { 
            if (user_data.categories[i].category != 'income')
            {
              expense += user_data.categories[i].expenses[j].monthlyProjection[getUTCCurrentMonth()];
            }
            else
            {
              income += user_data.categories[i].expenses[j].monthlyProjection[getUTCCurrentMonth()];
            }
          }
        }
        var balance = income - expense;
        chartData.push({
            "caption": "Income (+" + income.toString() + "$)",
            "budgeted": Math.floor(income),
            "color" : "#ff2655"
        });
        chartData.push({
            "caption": "Expense (-" + expense.toString() + "$)",
            "budgeted": Math.floor(-expense),
            "color" : "#ff2655"
        });
        chartData.push({
            "caption": "Balance (" + balance.toString() + "$)",
            "budgeted": Math.floor(balance),
            "color" : "#ff2655"
        });

      }
    }
  }
  else 
  {
    if (category == 'all')
    {
      for (var i = 0; i < user_data.categories.length; i++)
      {
        var amount = 0.0;
        var budgeted = user_data.categories[i].monthlyProjection[current_displayed_month];
        var caption = user_data.categories[i].caption;
        if (user_data.categories[i].category != 'income')
        {
          for (var j = 0; j < user_data.categories[i].expenses.length; j++)
          {
            amount += user_data.categories[i].expenses[j].monthlyTotals[current_displayed_month];
          }
          caption += " (" + percentageAsString(amount, budgeted) + ")";
          if (amount > 0.1 || budgeted > 0.1)
          {
            chartData.push({
                "caption": caption,
                "amount": Math.floor(amount),
                "budgeted": Math.floor(budgeted),
                "color" : "#ff2655"
            });
          }
        }
      }
    }
    else 
    {
      if (category != 'income')
      {
        var categoryObjects = user_data.categories.filter(function(item){return item.category == category; });
        for (var i = 0; i < categoryObjects[0].expenses.length; i++)
        {
          var amount = categoryObjects[0].expenses[i].monthlyTotals[current_displayed_month];
          var budgeted = categoryObjects[0].expenses[i].monthlyProjection[current_displayed_month];

          var caption = categoryObjects[0].expenses[i].caption;
          chartData.push({
              "caption": caption,
              "amount": Math.floor(amount),
              "budgeted": Math.floor(budgeted),
              "color" : "#ff2655"
          });     
        }
      }
      else 
      {
        var expense = 0.0;
        var income = 0.0;
        var budgetedExpense = 0.0;
        var budgetedIncome = 0.0;
        for (var i = 0; i < user_data.categories.length; i++)
        {
          for (var j = 0; j < user_data.categories[i].expenses.length; j++)
          { 
            if (user_data.categories[i].category != 'income')
            {
              budgetedExpense += user_data.categories[i].expenses[j].monthlyProjection[current_displayed_month];
              expense += user_data.categories[i].expenses[j].monthlyTotals[current_displayed_month];
            }
            else
            {
              budgetedIncome += user_data.categories[i].expenses[j].monthlyProjection[current_displayed_month];
              income += user_data.categories[i].expenses[j].monthlyTotals[current_displayed_month];
            }
          }
        }
        var balance = income - expense;
        chartData.push({
            "caption": "Income (+" + income.toString() + "$)",
            "amount": Math.floor(income),
            "budgeted": Math.floor(budgetedIncome),
            "color" : "#ff2655"
        });
        chartData.push({
            "caption": "Expense (-" + expense.toString() + "$)",
            "amount": Math.floor(-expense),
            "budgeted": Math.floor(-budgetedExpense),
            "color" : "#ff2655"
        });
        chartData.push({
            "caption": "Balance (" + balance.toString() + "$)",
            "amount": Math.floor(balance),
            "budgeted": Math.floor(budgetedIncome - budgetedExpense),
            "color" : "#ff2655"
        });
      }
    }
  }

  if (category != "income")
  {
    chartData.sort(compareExpense);
  }
  
  return chartData;
}

function generateBudgetedExpenseChartData() 
{
  var category = $('#current-context').text();
  var currentContext = document.getElementById("ui-board-select").value.toString();
  var result = generateExpenseChartData(currentContext, category);
  return result;
}

function generateTendencyChartData()
{
  var category = $('#current-context').text();
  return tendencyChartData(category);
}



function updateChartsHandler(evt)
{
  //expenseDonutChart.dataProvider = generateBudgetedExpenseChartData();
  //expenseDonutChart.validateData();

  tendencyBarChart.dataProvider = generateTendencyChartData();
  tendencyBarChart.validateData();

  balanceBarChart.dataProvider = generateBudgetedExpenseChartData();
  balanceBarChart.validateData();
}


function expenseMonthlyAmount(frequency, amount)
{
    switch(frequency)
    {
       case 'daily':
          return Math.floor(amount * 3000.0) / 100;
          break;
       case 'weekly':
          return Math.floor((amount / 7.0) * 3000.0) / 100;
          break;
       case 'monthly':
          return Math.floor(amount * 100) / 100;
          break;
       default:
          return Math.floor((amount / 12.0) * 100) / 100;
    }

}

function expenseYearlyAmount(frequency, amount)
{
    switch(frequency)
    {
       case 'daily':
          return Math.floor(amount * 36500.0) / 100;
          break;
       case 'weekly':
          return Math.floor((amount / 7.0) * 36500.0) / 100;
          break;
       case 'monthly':
          return Math.floor(amount * 1200.0) / 100;
          break;
       default:
          return Math.floor(amount * 100) / 100;
    }
}

function budgetedFrequencyUpdate(expenseId, category)
{
  var newFrequency = $('#ui-frequency-select' + expenseId.toString()).val();
  var categoryObjects = user_data.categories.filter(function(item){return item.category == category; });
  var expenseObjects = categoryObjects[0].expenses.filter(function(item) { return item.id == expenseId });
  expenseObjects[0].frequency = newFrequency;

  budgetedExpenseUpdate(expenseId, category, expenseObjects[0].value);
}


function expenseFrequencyCombo(frequency, expenseId, category)
{
    var html = '';

    html += '<select id="ui-frequency-select' + expenseId.toString() + '" onchange="budgetedFrequencyUpdate(\'' + expenseId + '\', \'' + category + '\')" class="ui-frequency-select">';
    html += '  <option value="daily"  '  + (frequency == 'daily' ? 'selected' : '') + '>Daily</option>';
    html += '  <option value="weekly"  '  + (frequency == 'weekly' ? 'selected' : '') + '>Weekly</option>';
    html += '  <option value="monthly"  '  + (frequency == 'monthly' ? 'selected' : '') + '>Monthly</option>';
    html += '  <option value="yearly"  '  + (frequency == 'yearly' ? 'selected' : '') + '>Yearly</option>';
    html += '</select>';

    return html;
}

function currentAmountModal(expenseId, category, isExpenseDialog)
{
  var categoryObjects = user_data.categories.filter(function(item){return item.category == category; });
  var expenseObjects = categoryObjects[0].expenses.filter(function(item) { return item.id == expenseId });

  $('#current-expense-id-for-dialog').text(expenseId);
  $('#current-category-for-dialog').text(category);
  
  if (isExpenseDialog)
  {
    $('#modal-dialog-input-amount').val('');
    $('#dialog-input-type').text('expenditure');
    $('#modal-dialog-input-label').text('Amount to add: ');
    $('#expense-entry-dialog-header').html('<button type="button" class="close" data-dismiss="modal">&times;</button>&nbsp;&nbsp;' + expenseObjects[0].caption + ' - current value: ' + expenseObjects[0].monthlyTotals[current_displayed_month].toString());
  }
  else
  {
    $('#modal-dialog-input-amount').val(expenseObjects[0].value);
    $('#dialog-input-type').text('budget');
    $('#modal-dialog-input-label').text('Budget Prevision: ');
    $('#expense-entry-dialog-header').html('<button type="button" class="close" data-dismiss="modal">&times;</button>&nbsp;&nbsp;' + expenseObjects[0].caption + ' - Budget Prevision: ');
  }
    

  // attempt to grab focus after the modal dialog poped up. 
  setTimeout(function(){ $('#modal-dialog-input-amount').focus(); }, 200);
  
}


function expenseProgress(percentage)
{
  var numericValue = Number(percentage.substring(0, percentage.length - 1));
  var progressbarType = 'progress-bar-info';
  if (numericValue > 60)
  {
    progressbarType = 'progress-bar-warning';
  }
  if (numericValue > 99)
  {
    progressbarType = 'progress-bar-danger';
  }

  var html = '<div class="progress">';
  html +='  <div class="progress-bar ' + progressbarType + '" role="progressbar" aria-valuenow="' + numericValue.toString() + '"';
  html +='  aria-valuemin="0" aria-valuemax="100" style="width:' + (numericValue > 100 ? 100 : numericValue).toString() +'%">';
  html +='    <span class="sr-only">' + percentage + '</span>';
  html +='  </div>';
  html +='</div>';

  return html;
}

function budgetInputUI(expenseId, category, amount) 
{
  if (typeof(amount) == "undefined")
    alert(expenseId + category);
  return '<div class="ui-expense-amount-hidden"> <a href="#" id="ui-expense-amount' + expenseId + '" data-toggle="modal" data-target="#expense-entry-dialog"  class="ui-fake-input" onclick="currentAmountModal(\'' + expenseId + '\', \'' + category + '\', false)"><div class="inner-fake-input">' + amount.toString() + '$</div></a></div>';
}

function expenseInputUI(expenseId, category, amount) 
{
  return '<div class="ui-current-amount"> <a href="#" id="ui-current-amount' + expenseId + '" data-toggle="modal" data-target="#expense-entry-dialog"  class="ui-fake-input" onclick="currentAmountModal(\'' + expenseId + '\', \'' + category + '\', true)"><div class="inner-fake-input">' + amount.toString() + '$</div></a></div>';
}

function expenseEntry(caption, frequency, budgetedAmount, expenseId, category)
{

    var html = '';

    html += '<li class="ui-expense-li category-' + category + '" id="' + expenseId + '">';
    html += '<div class="ui-expense-label-less-compact" id="ui-expense-label' + expenseId + '">' + caption + '</div>';
    html += '<div class="frequency-combo-container-hidden">'; 
    html += expenseFrequencyCombo(frequency, expenseId, category);
    html += '</div>';
    html += budgetInputUI(expenseId, category, budgetedAmount) ;
    html += '<div class="ui-monthly-amount-hidden '+ category +'-monthly-expense" id="ui-monthly-amount' + expenseId + '">'; 
    html += expenseMonthlyAmount(frequency, budgetedAmount)  + '$';
    html += '</div>';
    html += '<div class="ui-yearly-amount-hidden '+ category +'-yearly-expense" id="ui-yearly-amount' + expenseId + '">';  
    html += expenseYearlyAmount(frequency, budgetedAmount) + '$';
    html += '</div>';
    html += expenseInputUI(expenseId, category, 0)
    html += '<div class="ui-current-percentage" id="ui-current-percentage' + expenseId + '">';  
    html +=  expenseProgress('10%');
    html += '</div>';
    html += '</li>';

    $(html).insertAfter("." + category);

}


function updateTotalHandler(category)
{
  var categoryObjects = user_data.categories.filter(function(item){return item.category == category; });
  var monthlyValue = 0.0;
  var yearlyValue = 0.0;

  for (var i = 0; i < categoryObjects[0].expenses.length; i++)
  {
    monthlyValue += categoryObjects[0].expenses[i].monthlyProjection[current_displayed_month];
    yearlyValue += categoryObjects[0].expenses[i].yearlyProjection[current_displayed_month];
  }

  monthlyValue = (Math.floor(monthlyValue * 100.0)) / 100.0;
  yearlyValue = (Math.floor(yearlyValue * 100.0)) / 100.0;


  categoryObjects[0].monthlyProjection[current_displayed_month] = monthlyValue;
  categoryObjects[0].yearlyProjection[current_displayed_month] = yearlyValue;

  $('.' + category + '-monthly-total').text(monthlyValue.toString() + '$', null);
  $('.' + category + '-yearly-total').text(yearlyValue.toString() + '$', null);

}





function commitChange() {
  var date = new Date();
  user_data.lastCommit[0].year = date.getUTCFullYear();
  user_data.lastCommit[0].month = date.getUTCMonth();
  user_data.lastCommit[0].date = date.getUTCDate();
  user_data.lastCommit[0].hours = date.getUTCHours();
  user_data.lastCommit[0].minutes = date.getUTCMinutes();
  user_data.lastCommit[0].seconds = date.getUTCSeconds();

  var raw_data = JSON.stringify(user_data);

  // TODO uncomment for IPAGE
  //$.post( "savejson.php", { data: raw_data } );

  var session = sessionStorage.getItem(app_id + ".session");
  localStorage.setItem(app_id + "." + session + ".data", raw_data);
}


function fillSpreadsheetWithValuesForMonth(monthIndex)
{
  for (var i = 0; i < user_data.categories.length; i++)
  {
    var categoryId = user_data.categories[i].category;
    var monthlyProjectionForCategory = user_data.categories[i].monthlyProjection[monthIndex];
    var currentTotalExpenseForCategory = 0.0;
    for (var j = 0; j < user_data.categories[i].expenses.length; j++)
    {
      var expenseId = user_data.categories[i].expenses[j].id;
      var currentAmountForEntry = user_data.categories[i].expenses[j].monthlyTotals[monthIndex];
      if (expenseId != null && currentAmountForEntry != null)
      {
        var currentMonthlyProjectionForEntry = user_data.categories[i].expenses[j].monthlyProjection[monthIndex];
        currentTotalExpenseForCategory += currentAmountForEntry;

        $('#ui-current-amount' + expenseId).html('<div class="inner-fake-input">' + currentAmountForEntry.toString() + '$</div>');
        $('#ui-current-percentage' + expenseId).html(expenseProgress(percentageAsString(currentAmountForEntry, currentMonthlyProjectionForEntry))); 
      }
      else
      {
        alert("problem at " + categoryId + " and index" + j);
      }
    }

    currentTotalExpenseForCategory = (Math.floor(currentTotalExpenseForCategory * 100.0) / 100.0);
    $('.' + categoryId + '-current-total').text(currentTotalExpenseForCategory.toString() + '$'); 
    $('.' + categoryId + '-current-percentage').html(expenseProgress(percentageAsString(currentTotalExpenseForCategory, monthlyProjectionForCategory))); 
  }
}


function budgetedExpenseUpdate(id, category, amount) 
{
    var expenseFrequencyComboId = 'ui-frequency-select' + id.toString();
    var expenseAmountId = 'ui-expense-amount' + id.toString();

    var categoryObjects = user_data.categories.filter(function(item){return item.category == category; });
    var expenseObjects = categoryObjects[0].expenses.filter(function(item) { return item.id == id });
    
    expenseObjects[0].value = amount;

    $('#ui-expense-amount' + id).html('<div class="inner-fake-input">' + amount.toString() + '$</div>');


    var monthlyValue = 0.0;
    var yearlyValue = 0.0;
    switch(expenseObjects[0].frequency)
    {
    case 'daily':
       monthlyValue = Math.floor(amount * 3000.0) / 100;
       yearlyValue = Math.floor(amount * 36500.0) / 100;
       break;
    case 'weekly':
       monthlyValue = Math.floor((amount / 7.0) * 3000.0) / 100;
       yearlyValue = Math.floor((amount / 7.0) * 36500.0) / 100;
       break;
    case 'monthly':
       monthlyValue = Math.floor(amount * 100) / 100;
       yearlyValue = Math.floor(amount * 1200.0) / 100;
       break;
    default:
       monthlyValue = Math.floor((amount / 12.0) * 100) / 100;
       yearlyValue = Math.floor(amount * 100) / 100;
    }

    expenseObjects[0].monthlyProjection[current_displayed_month] = monthlyValue;
    expenseObjects[0].yearlyProjection[current_displayed_month] = yearlyValue;


    $("#ui-monthly-amount" + id.toString()).html(monthlyValue.toString() + '$', null);            
    $("#ui-yearly-amount" + id.toString()).html(yearlyValue.toString() + '$', null);




    updateTotalHandler(category);
    updateChartsHandler(null);



    commitChange();

    

    //var time = new Date();
    //$('.container').triggerHandler('expense-update-event', [id, expenseFrequencyComboValue, amount, category, time]);
}

function updateCurrentCategoryTotals(category)
{
  
  var currentTotalForCategory = 0.0;

  var categoryObjects = user_data.categories.filter(function(item){return item.category == category; });
  for (var i = 0; i < categoryObjects[0].expenses.length; i++)
  {
    currentTotalForCategory += categoryObjects[0].expenses[i].monthlyTotals[current_displayed_month];
  }
  currentTotalForCategory = (Math.floor(currentTotalForCategory * 100.00)) / 100.0;

  $('.' + category + '-current-total').text(currentTotalForCategory.toString() + '$');
  $('.' + category + '-current-percentage').html(expenseProgress(percentageAsString(currentTotalForCategory, categoryObjects[0].monthlyProjection[current_displayed_month])));

}



function currentExpenseUpdate(id, category, amountToAdd) 
{
  var categoryObjects = user_data.categories.filter(function(item){return item.category == category; });
  var expenseObjects = categoryObjects[0].expenses.filter(function(item) { return item.id == id });
  var budgetedAmount = expenseObjects[0].monthlyProjection[current_displayed_month];
  var currentAmount = expenseObjects[0].monthlyTotals[current_displayed_month];
  expenseObjects[0].monthlyTotals[current_displayed_month] += amountToAdd;


  $('#ui-current-percentage' + id).html(expenseProgress(percentageAsString(expenseObjects[0].monthlyTotals[current_displayed_month], budgetedAmount)));
  $('#ui-current-amount' + id).html('<div class="inner-fake-input">' + expenseObjects[0].monthlyTotals[current_displayed_month].toString() + '$</div>');

  updateChartsHandler(null);

  updateCurrentCategoryTotals(category);

  commitChange();

}


function boardSelectionChange()
{
  var selectedBoardLabel = $("#ui-board-select").val();
  if (selectedBoardLabel != "prevision")
  {
    $('.ui-expense-label').toggleClass('ui-expense-label ui-expense-label-less-compact');
    $('.frequency-combo-container').toggleClass('frequency-combo-container frequency-combo-container-hidden');
    $('.ui-expense-amount').toggleClass('ui-expense-amount ui-expense-amount-hidden');
    $('.ui-monthly-amount').toggleClass('ui-monthly-amount ui-monthly-amount-hidden');
    $('.ui-yearly-amount').toggleClass('ui-yearly-amount ui-yearly-amount-hidden');
    $('.ui-current-amount-hidden').toggleClass('ui-current-amount-hidden ui-current-amount');
    $('.ui-current-percentage-hidden').toggleClass('ui-current-percentage-hidden ui-current-percentage');

    current_displayed_month = (getUTCCurrentMonth() - Number(selectedBoardLabel));
    current_displayed_month = current_displayed_month < 0 ? current_displayed_month + 12 : current_displayed_month;

    fillSpreadsheetWithValuesForMonth(current_displayed_month);
  }
  else
  {
    $('.ui-expense-label-less-compact').toggleClass('ui-expense-label-less-compact ui-expense-label');
    $('.frequency-combo-container-hidden').toggleClass('frequency-combo-container-hidden frequency-combo-container');
    $('.ui-expense-amount-hidden').toggleClass('ui-expense-amount-hidden ui-expense-amount');
    $('.ui-monthly-amount-hidden').toggleClass('ui-monthly-amount-hidden ui-monthly-amount');
    $('.ui-yearly-amount-hidden').toggleClass('ui-yearly-amount-hidden ui-yearly-amount');
    $('.ui-current-amount').toggleClass('ui-current-amount ui-current-amount-hidden');
    $('.ui-current-percentage').toggleClass('ui-current-percentage ui-current-percentage-hidden');

    current_displayed_month = getUTCCurrentMonth();
  }

  updateChartsHandler(null);
}



function showCategory(category, isVisible)
{
  $("li.category-" + category).each(
    function (index) {
      switch (isVisible)
      {
        case true:
          $(this).removeClass('ui-screen-hidden');
          break;
        default:
          $(this).addClass('ui-screen-hidden');
          break;
      }
    }
  );
}

function revealCategoryOnly(category)
{
  var categories = ['housing', 'transportation','medical', 'utilities', 'personal', 'entertainment', 'household', 'giving', 'pets', 'insurance','taxes', 'debt', 'education', 'savings', 'income']; 

  $('#current-context').text(category);

  $.each(categories, 
    function(index, val) {
      showCategory(val, (val == category) || (category == 'all'));
    }
  );

}

function revealCategory() {
  var str = $(this).text().toLowerCase();
  if (str == 'all categories')
  {
    revealCategoryOnly('all');
  }
  else if (str == 'debt reduction')
  {
    revealCategoryOnly('debt');
  }
  else
  {
    revealCategoryOnly(str);
  }

  updateChartsHandler(null);
}

function clearExpensesForMonth(monthToClearIndex, lastValidMonthIndex) {
  if (monthToClearIndex != lastValidMonthIndex)
  {
    var m = monthToClearIndex;

    for (var i = 0; i < user_data.categories.length; i++)
    {
      var categoryObj = user_data.categories[i];
      categoryObj.monthlyProjection[m] = categoryObj.monthlyProjection[lastValidMonthIndex];
      categoryObj.yearlyProjection[m] = categoryObj.yearlyProjection[lastValidMonthIndex];
      for (var j = 0; j < categoryObj.expenses.length; j++)
      {
        var expenseObj = user_data.categories[i].expenses[j];
        expenseObj.monthlyTotals[m] = 0.0;
        expenseObj.monthlyProjection[m] = expenseObj.monthlyProjection[lastValidMonthIndex];
        expenseObj.yearlyProjection[m] = expenseObj.yearlyProjection[lastValidMonthIndex];
      }
    }
    
    m = (m <= 1) ? 11 : (m - 1);

    // let's perform a recursion in case several months have elapsed between the last valid month
    // and now (the monthe to clear). It will also clear all the months in between
    clearExpensesForMonth(m, lastValidMonthIndex);
  }

  user_data.currentMonthIndex = monthToClearIndex;
  commitChange();
}


function fetchEntryFromDialog(event) 
{
  if ((event.type == 'click') || (event.type == 'keydown' && (event.which == 13 || event.which == 9)))
  {
    var expenseId = $("#current-expense-id-for-dialog").text();
    var category = $("#current-category-for-dialog").text();
    var inputType = $("#dialog-input-type").text();
    var amount = Number($("#modal-dialog-input-amount").val());

    switch (inputType)
    {
      case 'expenditure':
        currentExpenseUpdate(expenseId, category, amount);
        break;
      case 'budget':
        budgetedExpenseUpdate(expenseId, category, amount);
        break;
    }

    $('#expense-entry-dialog').modal('hide');
  }
}




function buddjetStart()
{
  $('.container').removeClass('ui-screen-hidden');

  updateMonthsCombo();

  var raw_data = localStorage.getItem(app_id + "." + sessionStorage.getItem(app_id + ".session") + ".data");
  if (raw_data == null || typeof(raw_data) == "undefined" || raw_data.length < 100)
  {
    raw_data = new_user_raw_data;
  }
  user_data = JSON.parse(raw_data);

  // verify if file format has changed. 
  if (user_data.hasOwnProperty('formatVersion') == false || typeof(user_data.formatVersion) == "undefined" || user_data.formatVersion != current_format_version)
  {
    // TODO implement change of version updater

    // If it is the case unfortunately for now, reload vanilla config and all past changes will be lost.
    alert('file corruption, all data are lost');
    user_data = JSON.parse(new_user_raw_data);
  }

  
  // we need to check if the month has changed
  if (user_data.lastCommit[0].month != getUTCCurrentMonth())
  {
    clearExpensesForMonth(getUTCCurrentMonth(), user_data.lastCommit[0].month);
  }


  for (var i = 0; i < user_data.categories.length; i++)
  {
    var category = user_data.categories[i].category;
    var m = user_data.categories[i].monthlyProjection[current_displayed_month];
    var y = user_data.categories[i].yearlyProjection[current_displayed_month];
    for (var j = 0; j < user_data.categories[i].expenses.length; j++)
    {
      var expense = user_data.categories[i].expenses[j];
      expenseEntry(expense.caption , expense.frequency, expense.value, expense.id, category);
    }
    $('.' + category + '-monthly-total').text(m.toString() + '$');
    $('.' + category + '-yearly-total').text(y.toString() + '$');
    
  }



  fillSpreadsheetWithValuesForMonth(getUTCCurrentMonth());


  //$( ".expenses-list" ).listview( "refresh" );
  //$( ".income-list" ).listview( "refresh" );

/*

    expenseDonutChart = AmCharts.makeChart( "expenses-donut", {
      "type": "pie",
      "theme": "dark",
      "titles": [ {
        "text": "Budgeted expenses",
        "size": 16
      } ],
      
      "valueField": "amount",
      "titleField": "caption",
      "startEffect": "elastic",
      "startDuration": 2,
      "labelRadius": 15,
      "innerRadius": "50%",
      "depth3D": 20,
      "balloonText": "[[title]]<br><span style='font-size:14px'><b>[[value]]</b> ([[percents]]%)</span>",
      "angle": 40,
      "export": {
        "enabled": false
      }
    } );

*/

    balanceBarChart = AmCharts.makeChart("expenses-vs-prevision-barchart", {
          "theme": "dark",
          "type": "serial",
          "valueAxes": [{
              "stackType": "3d",
              "unit": "$",
              "position": "left",
              "title": "Expense vs Prevision",
          }],
          "startDuration": 1,
          "graphs": [{
              "balloonText": "Expenses",
              "fillAlphas": 0.6,
              "lineAlpha": 0.2,
              "title": "Expenses",
              "type": "column",
              "valueField": "amount",
              "startEffect": "easyOutSine",
              "lineColor" : getRandomColor()
          }, {
              "balloonText": "Budgeted Prevision",
              "fillAlphas": 0.6,
              "lineAlpha": 0.2,
              "title": "Budgeted Prevision",
              "type": "column",
              "valueField": "budgeted",
              "startEffect": "easyOutSine",
              "lineColor" : getRandomColor()
          }
          ],
          "plotAreaFillAlphas": 0.1,
          "depth3D": 40,
          "angle": 30,
          "categoryField": "caption",
          "categoryAxis": {
              "gridPosition": "start",
              "labelRotation": 45
          },
          "export": {
            "enabled": false
           }
      });


      /*
      tendencyBarChart = AmCharts.makeChart("tendency-barchart", {
          "theme": "dark",
          "type": "serial",
          "valueAxes": [{
              "stackType": "3d",
              "unit": "$",
              "position": "left",
              "title": "Expense vs Prevision",
          }],
          "startDuration": 1,
          "graphs": [{
              "balloonText": "Expenses",
              "fillAlphas": 0.6,
              "lineAlpha": 0.2,
              "title": "Expenses",
              "type": "column",
              "valueField": "amount",
              "lineColor" : getRandomColor()
          }, {
              "balloonText": "Budgeted Prevision",
              "fillAlphas": 0.6,
              "lineAlpha": 0.2,
              "title": "Budgeted Prevision",
              "type": "column",
              "valueField": "budgeted",
              "lineColor" : getRandomColor()
          }],
          "plotAreaFillAlphas": 0.1,
          "depth3D": 60,
          "angle": 30,
          "categoryField": "caption",
          "categoryAxis": {
              "gridPosition": "start",
              "labelRotation": 45
          },
          "export": {
            "enabled": false
           }
      });
*/


      tendencyBarChart = AmCharts.makeChart( "tendency-barchart", {
        "type": "serial",
        "addClassNames": true,
        "theme": "black",
        "autoMargins": true,
        "marginLeft": 30,
        "marginRight": 8,
        "marginTop": 10,
        "marginBottom": 26,
        
        "balloon": {
          "adjustBorderColor": false,
          "horizontalPadding": 10,
          "verticalPadding": 8,
          "color": "#ffffff"
        },

        "valueAxes": [ {
          "title": "Monthly Expenditure vs Prevision",
          "titleColor" : "#ffffff",
          "axisAlpha": 0,
          "position": "left",
          "unit": "$",
          "color": "#ffffff",
          "gridColor": "#ffffff"

        } ],
        "startDuration": 0,
        "graphs": [ {
          "alphaField": "alpha",
          "balloonText": "<span style='font-size:12px;'>[[title]] in [[category]]:<br><span style='font-size:20px;'>[[value]]$</span>",
          "fillAlphas": 1,
          "title": "Budgeted Prevision",
          "type": "column",
          "valueField": "budgeted",
          "startEffect": "easyOutSine",
          "dashLengthField": "dashLengthColumn",
        }, 
        {
          "id": "graph2",
          "balloonText": "<span style='font-size:12px;'>[[title]] in [[category]]:<br><span style='font-size:20px;'>[[value]]$</span> [[additional]]</span>",
          "bullet": "square",
          "lineThickness": 3,
          "bulletSize": 7,
          "bulletBorderAlpha": 1,
          "bulletColor": "#FFFFFF",
          "useLineColorForBulletBorder": true,
          "bulletBorderThickness": 3,
          "fillAlphas": 0,
          "lineAlpha": 1,
          "title": "Expenditure",
          "valueField": "amount",
          "startEffect": "easyOutSine",
          "dashLengthField": "dashLengthLine"
        },
        {
          "id": "graph3",
          "balloonText": "<span style='font-size:12px;'>[[title]] in [[category]]:<br><span style='font-size:20px;'>[[value]]$",
          "bullet": "round",
          "lineThickness": 3,
          "bulletSize": 7,
          "bulletBorderAlpha": 1,
          "bulletColor": "#FFFFFF",
          "useLineColorForBulletBorder": true,
          "bulletBorderThickness": 3,
          "fillAlphas": 0,
          "lineAlpha": 1,
          "title": "Income",
          "valueField": "income",
          "startEffect": "easyOutSine",
          "dashLengthField": "dashLengthLine"
        } ,
        {
          "id": "graph4",
          "balloonText": "<span style='font-size:12px;'>[[title]] in [[category]]:<br><span style='font-size:20px;'>[[value]]$",
          "bullet": "round",
          "lineThickness": 3,
          "bulletSize": 7,
          "bulletBorderAlpha": 1,
          "bulletColor": "#FFFFFF",
          "useLineColorForBulletBorder": true,
          "bulletBorderThickness": 3,
          "fillAlphas": 0,
          "lineAlpha": 1,
          "title": "Budgeted Income",
          "valueField": "budgetedIncome",
          "startEffect": "easyOutSine",
          "dashLengthField": "dashLengthLine"
        }  ],
        "categoryField": "caption",
        "categoryAxis": {
          "gridPosition": "start",
          "gridColor": "#ffffff",
          "axisAlpha": 0,
          "tickLength": 0,
          "labelRotation": 45,
          "color": "#ffffff",

        },
        "export": {
          "enabled": false
        }
      } );


      updateChartsHandler(null);



    

    $('#one').on('click', 
      function() { 
        switch($('#one').attr('data-cacheval'))
        {
          case 'true':
            $('#sidebar2')
              .addClass('charts-mobile-on')
              .removeClass('charts-mobile-off');
            break;
          default:
            $('#sidebar2')
              .addClass('charts-mobile-off')
              .removeClass('charts-mobile-on');
            break;
        }
        
      }
    );


    $("#a-income-sidebar-entry").on('click', revealCategory);
    $("#a-housing-sidebar-entry").on('click', revealCategory);
    $("#a-transportation-sidebar-entry").on('click', revealCategory);
    $("#a-medical-sidebar-entry").on('click', revealCategory);
    $("#a-utilities-sidebar-entry").on('click', revealCategory);
    $("#a-personal-sidebar-entry").on('click', revealCategory);
    $("#a-entertainment-sidebar-entry").on('click', revealCategory);
    $("#a-household-sidebar-entry").on('click', revealCategory);
    $("#a-giving-sidebar-entry").on('click', revealCategory);
    $("#a-pets-sidebar-entry").on('click', revealCategory);
    $("#a-insurance-sidebar-entry").on('click', revealCategory);
    $("#a-taxes-sidebar-entry").on('click', revealCategory);
    $("#a-debt-sidebar-entry").on('click', revealCategory);
    $("#a-education-sidebar-entry").on('click', revealCategory);
    $("#a-savings-sidebar-entry").on('click', revealCategory);
    $("#a-home-sidebar-entry").on('click', revealCategory);


    $("#validate-new-amount-modal-dialog-btn").unbind().click( fetchEntryFromDialog);
    $("#modal-dialog-input-amount").unbind().keydown( fetchEntryFromDialog);
 

}


